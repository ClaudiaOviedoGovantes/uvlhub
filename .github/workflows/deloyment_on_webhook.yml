# ----------------------------------------------------------------------------
# Deploy on Webhook Workflow
# This workflow triggers a deployment webhook only after the "Python Lint"
# and "Run tests" workflows have successfully completed on the main branch.
# ----------------------------------------------------------------------------

name: Deploy on Webhook

on:
  workflow_run:
    # Trigger this workflow after these workflows complete
    workflows: 
      - "Python Lint"
      - "Run tests"
    types:
      - completed

jobs:
  deploy:
    # Run deployment only on the main branch
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04

    steps:
      
      # Step 1: Verify that the previous workflows succeeded
      - name: Check lint and test results
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "Lint or Test workflow did not succeed. Exiting."
            exit 1
          fi

      # Step 2: Trigger the external deployment webhook
      - name: Trigger Deployment Webhook
        env:
          WEBHOOK_DOMAIN: ${{ secrets.WEBHOOK_DOMAIN }}
          WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
        run: |
          curl -X POST \
            https://${{ secrets.WEBHOOK_DOMAIN }}/webhook/deploy \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_TOKEN }}"
